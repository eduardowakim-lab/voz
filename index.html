<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Robo Realtime Teste</title>
<style>
body{
  margin:0;
  background:#071a2e;
  color:white;
  font-family:Arial;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  height:100vh;
}
#status{margin-bottom:20px;}
#mouth{
  width:200px;
  height:80px;
  background:black;
  border-radius:0 0 200px 200px;
  transition:height .05s linear;
}
button{
  margin-top:30px;
  padding:12px 20px;
  font-weight:bold;
  cursor:pointer;
}
</style>
</head>
<body>

<div id="status">Desconectado</div>
<div id="mouth"></div>
<button id="btn">Conectar</button>

<audio id="remoteAudio" autoplay playsinline></audio>

<script>
const OPENAI_API_KEY = "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"; // ‚ö†Ô∏è TESTE APENAS

let pc;
let audioCtx;
let analyser;
let data;
let stream;

const mouth = document.getElementById("mouth");
const remoteAudio = document.getElementById("remoteAudio");
const status = document.getElementById("status");
const btn = document.getElementById("btn");

btn.onclick = async () => {
  btn.disabled = true;
  status.textContent = "Conectando...";

  audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  stream = await navigator.mediaDevices.getUserMedia({ audio:true });

  pc = new RTCPeerConnection();

  // enviar microfone
  const track = stream.getAudioTracks()[0];
  pc.addTrack(track, stream);

  // receber √°udio do modelo
  remoteAudio.srcObject = new MediaStream();
  pc.ontrack = e => {
    e.streams[0].getTracks().forEach(t => {
      remoteAudio.srcObject.addTrack(t);
    });
    connectAnalyser();
  };

  // criar offer
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  const baseUrl = "https://api.openai.com/v1/realtime?model=gpt-realtime-mini";

  const response = await fetch(baseUrl, {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + OPENAI_API_KEY,
      "Content-Type": "application/sdp"
    },
    body: offer.sdp
  });

  const answer = await response.text();
  await pc.setRemoteDescription({ type:"answer", sdp:answer });

  status.textContent = "Conectado üéôÔ∏è";
  loop();
};

function connectAnalyser(){
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 1024;
  data = new Uint8Array(analyser.fftSize);

  const source = audioCtx.createMediaElementSource(remoteAudio);
  source.connect(analyser);
  analyser.connect(audioCtx.destination);
}

function rms(u8){
  let sum=0;
  for(let i=0;i<u8.length;i++){
    const x=(u8[i]-128)/128;
    sum+=x*x;
  }
  return Math.sqrt(sum/u8.length);
}

function loop(){
  analyser.getByteTimeDomainData(data);
  const level = rms(data);
  const open = 60 + level*200;
  mouth.style.height = open+"px";
  requestAnimationFrame(loop);
}
</script>

</body>
</html>
